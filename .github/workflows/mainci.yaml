name: Build and Deploy to Prod

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Use Node.js 20.10.0
        uses: actions/setup-node@v2
        with:
          node-version: 20.10.0

      - name: Install dependencies
        run: |
          npm install -g pnpm
          pnpm install

      - name: Build
        run: npm run build

      - name: Remove src and node_modules
        run: |
          rm -rf src
          rm -rf node_modules
          rm -f .gitignore  # Remove .gitignore file
          # add a new .gitignore file with .gitignore content .env
          echo ".env" > .gitignore

      - name: Push to prod branch
        run: |
          git config --global user.email "github-actions@example.com"
          git config --global user.name "GitHub Actions"
          git checkout -b prod
          git add .
          git commit -m "Builded data for prod"
          # Force push to prod branch
            git push -f origin prod
